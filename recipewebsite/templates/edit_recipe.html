{% extends "base.html" %}
{% block content %}
{% load widget_tweaks %}

<div class="container my-5">
	<h1 class="mb-4">{% if form.instance.pk %}Editar Receita{% else %}Criar Receita{% endif %}</h1>

	<form method="POST" enctype="multipart/form-data" novalidate id="recipeForm">
		{% csrf_token %}
		{% if messages %}
			{% for message in messages %}
				<div class="alert alert-danger alert-dismissible fade show" role="alert">
					{{ message }}
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
			{% endfor %}
		{% endif %}

		<!-- === Main Recipe Form === -->
		<div class="card mb-4 shadow-sm">
			<div class="card-body">
			<div class="mb-3">
				<label for="{{ form.name.id_for_label }}" class="form-label">Nome</label>
					{{ form.name|add_class:"form-control" }}
					{% if form.name.errors %}
						<div class="invalid-feedback d-block">{{ form.name.errors|striptags }}</div>
					{% endif %}
				</div>

			<div class="mb-3">
				<label for="{{ form.img.id_for_label }}" class="form-label">Imagem</label>
				<br>
				{{ form.img|add_class:"form-control" }}
				{% if form.img.errors %}
					<div class="invalid-feedback d-block">{{ form.img.errors|striptags }}</div>
				{% endif %}
				</div>

			<div class="mb-3">
				<label for="{{ form.sliderImg.id_for_label }}" class="form-label">Imagem Slider</label>
				<br>
				{{ form.sliderImg|add_class:"form-control" }}
				{% if form.sliderImg.errors %}
					<div class="invalid-feedback d-block">{{ form.sliderImg.errors|striptags }}</div>
				{% endif %}
				</div>

			<div class="mb-3">
				<label class="form-label">Dificuldade</label>
					<div class="star-rating-wrapper">
						<div class="star-rating">
							{% for value, label in form.difficulty.field.choices reversed %}
								<input type="radio" id="star{{ value }}" name="difficulty" value="{{ value }}"
									{% if form.difficulty.value != None and form.difficulty.value|stringformat:"i" == value|stringformat:"i" %}checked{% endif %}>
								<label for="star{{ value }}" title="{{ label }}">
									<i class="bi bi-mortarboard-fill"></i>
								</label>
							{% endfor %}
						</div>
					</div>
					{% if form.difficulty.errors %}
						<div class="invalid-feedback d-block">{{ form.difficulty.errors|striptags }}</div>
					{% endif %}
				</div>


			<div class="mb-3">
				<label for="{{ form.duration.id_for_label }}" class="form-label">Tempo de Preparo</label>
				<div class="input-group">
					{{ form.duration|add_class:"form-control"|attr:"min:1"|attr:"type:number" }}
					<span class="input-group-text">minutos</span>
				</div>
				{% if form.duration.errors %}
					<div class="invalid-feedback d-block">{{ form.duration.errors|striptags }}</div>
				{% endif %}
			</div>

			<div class="mb-3">
				<label for="{{ form.description.id_for_label }}" class="form-label">Descrição</label>
					{{ form.description|add_class:"form-control" }}
					{% if form.description.errors %}
						<div class="invalid-feedback d-block">{{ form.description.errors|striptags }}</div>
					{% endif %}
				</div>

			<div class="mb-3">
				<label for="{{ form.category.id_for_label }}" class="form-label">Categoria</label>
					{{ form.category|add_class:"form-select" }}
					{% if form.category.errors %}
						<div class="invalid-feedback d-block">{{ form.category.errors|striptags }}</div>
					{% endif %}
				</div>

			</div>
		</div>

		<!-- === Ingredients === -->
		<div class="card mb-4 shadow-sm">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h4 class="mb-0">Ingredientes</h4>
			</div>
			<div class="card-body" id="ingredients-formset">
				{{ ingredients_formset.management_form }}
				<table class="table table-bordered align-middle" id="ingredients-table">
					<thead class="table-light">
						<tr>
							<th>Descrição</th>
							<th style="width: 120px">Ordem</th>
							<th style="width: 100px">Ações</th>
						</tr>
					</thead>
					<tbody>
						{% for form in ingredients_formset %}
							<tr class="sortable-row">
								{{ form.id }}
								{{ form.DELETE}}
								<td class="handle" style="cursor: grab">⬍ {{ form.text|add_class:"form-control" }}</td>
								<td>{{ form.sequence|add_class:"form-control"|attr:"readonly:true" }}</td>
							<td>
								<button type="button" class="remove-form btn btn-outline-danger btn-sm">
									<i class="bi bi-trash"></i> Remover
								</button>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>

				<template id="empty-ingredients-form">
					<tr class="sortable-row">
						{{ ingredients_formset.empty_form.id }}
						<td class="handle" style="cursor: grab">⬍ {{ ingredients_formset.empty_form.text|add_class:"form-control" }}</td>
						<td>{{ ingredients_formset.empty_form.sequence|add_class:"form-control" }}</td>
						<td>
							<button type="button" class="remove-form btn btn-outline-danger btn-sm">
								<i class="bi bi-trash"></i> Remover
							</button>
						</td>
					</tr>
				</template>
			</div>
			<div class="card-footer">
				<button type="button" id="add-ingredients" class="btn btn-outline-primary btn-sm">
					<i class="bi bi-plus-lg"></i> Adicionar Ingrediente
				</button>
			</div>
		</div>

		<!-- === Steps === -->
		<div class="card mb-4 shadow-sm">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h4 class="mb-0">Passos</h4>
			</div>
			<div class="card-body" id="steps-formset">
				{{ steps_formset.management_form }}
				<table class="table table-bordered align-middle" id="steps-table">
					<thead class="table-light">
						<tr>
							<th>Instrução</th>
							<th style="width: 120px">Ordem</th>
							<th style="width: 100px">Ações</th>
						</tr>
					</thead>
					<tbody>
						{% for form in steps_formset %}
							<tr class="sortable-row">
								{{ form.id }}
								{{ form.DELETE }}
								<td class="handle" style="cursor: grab">⬍ {{ form.text|add_class:"form-control" }}</td>
								<td>{{ form.sequence|add_class:"form-control" }}</td>
								<td>
									<button type="button" class="remove-form btn btn-outline-danger btn-sm">
										<i class="bi bi-trash"></i> Remove
									</button>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>

				<template id="empty-steps-form">
					<tr class="sortable-row">
						{{ steps_formset.empty_form.id }}
						<td class="handle" style="cursor: grab">⬍ {{ steps_formset.empty_form.text|add_class:"form-control" }}</td>
						<td>{{ steps_formset.empty_form.sequence|add_class:"form-control" }}</td>
						<td>
							<button type="button" class="remove-form btn btn-outline-danger btn-sm">
								<i class="bi bi-trash"></i> Remove
							</button>
						</td>
					</tr>
				</template>
			</div>
			<div class="card-footer">
				<button type="button" id="add-steps" class="btn btn-outline-primary btn-sm">
					<i class="bi bi-plus-lg"></i> Adicionar Passo
				</button>
			</div>
		</div>

	<!-- === Submit === -->
	<button type="submit" class="btn btn-success btn-lg">
		<i class="bi bi-save"></i> {% if form.instance.pk %}Salvar Receita{% else %}Criar Receita{% endif %}
	</button>
	</form>
</div>

<!-- === SortableJS === -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // =============================
  // Grab the main form element
  // =============================
  const form = document.querySelector("#recipeForm");
  console.log(form)

  // =============================
  // Function: Update sequence numbers for a table
  // Why: Ensures that each ingredient or step has the correct order after adding/removing/reordering
  // =============================
  function updateSequencesForTable(tableSelector) {
    const rows = document.querySelectorAll(`${tableSelector} tbody tr`);
    rows.forEach((row, index) => {
      const seqInput = row.querySelector('input[name$="sequence"]');
      if (seqInput) seqInput.value = index + 1;
    });
  }

  // =============================
  // Function: Validate a single textarea field
  // Why: Adds inline feedback if a required field is empty
  // Returns: true if valid, false if empty
  // =============================
  function validateField(field) {
    const errorClass = "is-invalid";
    const errorMessage = field.getAttribute("data-error") || "This field is required.";
    let feedback = field.nextElementSibling;

    // If no feedback element exists, create one
    if (!feedback || !feedback.classList.contains("invalid-feedback")) {
      feedback = document.createElement("div");
      feedback.className = "invalid-feedback";
      feedback.textContent = errorMessage;
      field.insertAdjacentElement("afterend", feedback);
    }

    // Validate the field value
    if (!field.value.trim()) {
      field.classList.add(errorClass);
      feedback.style.display = "block";
      return false;
    } else {
      field.classList.remove(errorClass);
      feedback.style.display = "none";
      return true;
    }
  }

  // =============================
  // Function: Validate all textareas in the form
  // Loops through all ingredient and step fields
  // =============================
  function validateAllFields(form) {
	let valid = true;
	form.querySelectorAll('textarea[name$="text"]').forEach(field => {
		const deleteInput = field.closest('tr')?.querySelector('input[name$="DELETE"]');
		if (deleteInput && deleteInput.checked) return;
		if (!validateField(field)) valid = false;
	});
	return valid;
	}


  // =============================
  // Function: Mark empty formset rows for deletion
  // Why: Django will ignore any form marked for deletion, preventing empty rows from being saved
  // =============================
  function removeEmptyRows(prefix) {
    const rows = document.querySelectorAll(`#${prefix}-table tbody tr`);
    rows.forEach(row => {
      const textarea = row.querySelector('textarea[name$="text"]');
		console.log(textarea)
      const deleteInput = row.querySelector('.remove-form');
	  console.log(deleteInput);
      if (textarea && deleteInput && textarea.value.trim() === "") {
		console.log(textarea)
		textarea.closest("tr")?.remove();
		updateSequencesForTable("#ingredients-table");
		updateSequencesForTable("#steps-table");
        deleteInput.checked = true; // Mark the form for deletion
      }
    });
  }

  // =============================
  // Function: Dynamically add a new formset row
  // Why: Lets users add more ingredients or steps without refreshing the page
  // =============================
  function addForm(prefix) {
    const totalForms = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
    const tableBody = document.querySelector(`#${prefix}-table tbody`);
    const template = document.querySelector(`#empty-${prefix}-form`);
    if (!totalForms || !tableBody || !template) return;

    const formCount = parseInt(totalForms.value);
    // Replace the __prefix__ placeholder with the new index
    const newFormHtml = template.content.firstElementChild.outerHTML.replace(/__prefix__/g, formCount);
    const tempRow = document.createElement("tr");
    tempRow.innerHTML = newFormHtml;

    // Attach real-time validation to the newly added field
    tempRow.querySelectorAll('textarea[name$="text"]').forEach(field => {
      field.addEventListener("input", () => validateField(field));
    });

    // Add the new row to the table and increment the TOTAL_FORMS counter
    tableBody.appendChild(tempRow);
    totalForms.value = formCount + 1;

    // Recalculate sequences after adding a new row
    updateSequencesForTable("#ingredients-table");
    updateSequencesForTable("#steps-table");
  }

  // =============================
  // Event listeners for "Add Ingredient" and "Add Step" buttons
  // =============================
  document.getElementById("add-ingredients")?.addEventListener("click", () => addForm("ingredients"));
  document.getElementById("add-steps")?.addEventListener("click", () => addForm("steps"));

  // =============================
  // Event listener for removing a form row
  // Why: Allows users to remove unwanted ingredients or steps
  // =============================
  document.addEventListener("click", e => {
    const btn = e.target.closest(".remove-form");
    if (btn) {
      btn.closest("tr")?.remove();
      updateSequencesForTable("#ingredients-table");
      updateSequencesForTable("#steps-table");
    }
  });

  // =============================
  // Initialize SortableJS for drag-and-drop reordering
  // Why: Users can rearrange ingredients or steps by dragging them
  // Updates sequence numbers after any reorder
  // =============================
  const ingredientsTable = document.querySelector("#ingredients-table tbody");
  const stepsTable = document.querySelector("#steps-table tbody");
  if (ingredientsTable) Sortable.create(ingredientsTable, {
    handle: ".handle",
    animation: 150,
    onEnd: () => updateSequencesForTable("#ingredients-table")
  });
  if (stepsTable) Sortable.create(stepsTable, {
    handle: ".handle",
    animation: 150,
    onEnd: () => updateSequencesForTable("#steps-table")
  });

  // =============================
  // Attach real-time validation to existing textareas
  // =============================
  form.querySelectorAll('textarea[name$="text"]').forEach(field => {
    field.addEventListener("input", () => validateField(field));
  });

  // =============================
  // Form submission handler
  // Steps:
  // 1. Trim all textarea values
  // 2. Mark empty rows for deletion
  // 3. Validate all fields
  // 4. Prevent submission if validation fails
  // =============================
  form.addEventListener("submit", e => {
    // Step 1: Trim all textareas
    form.querySelectorAll('textarea[name$="text"]').forEach(field => {
      field.value = field.value.trim();
    });

    // Step 2: Remove empty rows
	console.log("removing empty rows code")
    removeEmptyRows("ingredients");
    removeEmptyRows("steps");

    // Step 3 & 4: Validate and block submission if any required field is empty
    if (!validateAllFields(form)) {
      e.preventDefault();
      const firstError = form.querySelector(".is-invalid");
      firstError?.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  });

  // =============================
  // Initialize sequences on page load
  // Why: Ensures proper numbering if editing an existing recipe
  // =============================
  updateSequencesForTable("#ingredients-table");
  updateSequencesForTable("#steps-table");

});
</script>

{% endblock %}